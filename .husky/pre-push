# Get the current branch name
current_branch=$(git rev-parse --abbrev-ref HEAD)
remote_branch="origin/$current_branch"

# Try to get the remote tracking branch, fall back to origin/main if not found
if ! git rev-parse --verify "$remote_branch" >/dev/null 2>&1; then
  remote_branch="origin/main"
fi

# Get list of changed files between HEAD and remote branch
changed_files=$(git diff --name-only HEAD "$remote_branch" 2>/dev/null || echo "")

# If no remote branch found or no changes, also check what's staged
if [ -z "$changed_files" ]; then
  changed_files=$(git diff --cached --name-only)
fi

# Patterns for userscript-related files
userscript_patterns="src/.*\.ts$|src/.*\.js$|src/userscript\.template\.js$|src/bookmarklet\.template\.js$|webpack\.userscript\.config\.js$|webpack\.bookmarklet\.config\.js$|style/eventuate\.css$"

# Patterns for docs site (triggers Lighthouse)
docs_patterns="^docs/|^src/bookmarklet\.template\.md$"

# Check if any userscript-related files have changed
userscript_changed=$(echo "$changed_files" | grep -E "$userscript_patterns" || echo "")

# Check if any docs-related files have changed
docs_changed=$(echo "$changed_files" | grep -E "$docs_patterns" || echo "")

if [ -n "$docs_changed" ]; then
  echo "üìê Docs or bookmarklet files have been modified. Running Lighthouse (builds docs with local URLs)..."
  if ! pnpm run lighthouse; then
    echo "‚ùå Lighthouse scores below 100 (accessibility, best-practices, or SEO). Please fix before pushing."
    exit 1
  fi
  echo "‚úÖ Lighthouse passed."
fi

if [ -n "$userscript_changed" ]; then
  echo "üì∏ Userscript files have been modified. Generating screenshots..."
  if ! pnpm build; then
    echo "‚ùå Build failed. Please fix build errors before pushing."
    exit 1
  fi
  if ! pnpm screenshots; then
    echo "‚ö†Ô∏è  Screenshot generation failed. Push will continue, but please generate screenshots manually."
  fi
fi

exit 0
